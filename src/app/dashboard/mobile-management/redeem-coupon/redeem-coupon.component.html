<!--TODO: Agregar modo de input por escrito (cupón e id de usuario)-->

<div
  id="scanner-container"
  class="bg-white"
  *ngIf="readMode === 'qr' && scannerIsActive"
>
  <zxing-scanner
    #scanner
    [(device)]="currentDevice"
    (scanSuccess)="onScanSuccess($event)"
    (permissionResponse)="onHasPermission($event)"
    (camerasFound)="onCamerasFound($event)"
  >
  </zxing-scanner>
</div>

<div id="scanned-qr-info" class="mt-3">
  <div class="card h-100">
    <div class="card-header p-1">
      <div class="d-flex justify-content-between align-items-center">
        <div class="align-items-center ml-2">
          {{ optionsVisible ? "Opciones de lector" : "Info de QR" }}
        </div>

        <div>
          <button
            type="button btn-sm"
            class="btn btn-outline-dark px-3 mr-2"
            (click)="beginScanning()"
          >
            <i class="fa fa-camera" aria-hidden="true"></i>
          </button>

          <button
            *ngIf="debugMode"
            type="button btn-sm"
            class="btn btn-outline-dark px-3 mr-2"
            (click)="onScanTest()"
          >
            <i class="fa fa-search" aria-hidden="true"></i>
          </button>

          <button
            type="button btn-sm"
            class="btn btn-outline-dark px-3 mr-2"
            (click)="onEnterWithKeyboard()"
          >
            <i class="fa fa-code" aria-hidden="true"></i>
          </button>

          <button
            type="button btn-sm"
            class="btn btn-outline-dark px-3 mr-2"
            (click)="toggleOptions()"
          >
            <i class="fa fa-cog" aria-hidden="true"></i>
          </button>
        </div>
      </div>
    </div>

    <ng-container *ngTemplateOutlet="redemptionStatus"> </ng-container>

    <ng-container *ngTemplateOutlet="scannerOptions"> </ng-container>
  </div>
</div>

<div class="card mt-3">
  <div class="card-body">
    <div class="d-flex justify-content-between bg-white">
      <button
        class="btn btn-outline-danger w-100"
        (click)="redeemCouponService.cleanScannedCode()"
      >
        Limpiar código
      </button>
    </div>
  </div>
</div>

<ng-template #redemptionStatus>
  <div class="card-body" *ngIf="!optionsVisible">
    <p *ngIf="!redeemCouponService.couponStatusRetrieved">
      Proceda a leer el código QR que desea canjear el cliente
    </p>

    <p
      *ngIf="
        this.redeemCouponService.coupon && this.redeemCouponService.customer
      "
    >
      Cupón: {{ this.redeemCouponService.coupon.title }} <br />
      Cliente:
      {{
        this.redeemCouponService.customer.firstName +
          " " +
          this.redeemCouponService.customer.lastName
      }}
    </p>

    <div
      *ngIf="
        redeemCouponService.couponStatusRetrieved ||
        (redeemCouponService.redemptionStatus.status &&
          redeemCouponService.redemptionStatus.message)
      "
    >
      <hr
        class="mt-1 mb-1"
        *ngIf="
          this.redeemCouponService.coupon && this.redeemCouponService.customer
        "
      />

      <div
        class="p-1 alert alert-primary"
        role="alert"
        *ngIf="redeemCouponService.redeemingInProcess"
      >
        <p class="m-0 text-center">El cupón está siendo canjeado...</p>
      </div>

      <div
        class="p-1 alert"
        [ngClass]="{
          'alert-success':
            redeemCouponService.redemptionStatus.status === 'success',
          'alert-danger':
            redeemCouponService.redemptionStatus.status === 'error'
        }"
        role="alert"
        *ngIf="
          !redeemCouponService.redeemingInProcess &&
          redeemCouponService.redemptionStatus.status &&
          redeemCouponService.redemptionStatus.message
        "
      >
        <p class="m-0 text-center">
          {{ redeemCouponService.redemptionStatus.message }}
        </p>
      </div>

      <div
        class="p-1 alert alert-primary"
        role="alert"
        *ngIf="
          !redeemCouponService.notValid &&
          !redeemCouponService.alreadyExpired &&
          !redeemCouponService.alreadyRedeemed &&
          redeemCouponService.couponStatus.canRedeem &&
          !redeemCouponService.redeemingInProcess &&
          !redeemCouponService.redemptionStatus.status &&
          !redeemCouponService.redemptionStatus.message
        "
      >
        <p class="m-0 text-center">El cupón puede ser canjeado</p>
      </div>

      <div
        class="p-1 alert alert-danger"
        role="alert"
        *ngIf="
          !redeemCouponService.couponStatus.canRedeem &&
          !redeemCouponService.redeemingInProcess
        "
      >
        <p
          class="m-0 text-center"
          class="m-0 text-center"
          *ngIf="redeemCouponService.notValid"
        >
          Código QR no válido para esta operación. Valor del código:
        </p>

        <p
          class="m-0 text-center"
          *ngIf="
            redeemCouponService.alreadyRedeemed &&
            !redeemCouponService.redeemingInProcess
          "
        >
          Este cupón ya fue canjeado por el cliente.
        </p>

        <p
          class="m-0 text-center"
          *ngIf="
            redeemCouponService.alreadyExpired &&
            !redeemCouponService.redeemingInProcess
          "
        >
          Este cupón ya expiró.
        </p>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #scannerOptions>
  <div class="card-body p-2" *ngIf="optionsVisible">
    <label
      >Cámara actual:
      {{ currentDevice ? currentDevice.deviceId : "Ninguna" }}</label
    >
    <select
      class="form-control"
      (change)="onDeviceSelectChange($event.target.value)"
    >
      <option
        *ngFor="let device of availableDevices"
        [value]="device.deviceId"
        [selected]="currentDevice && device.deviceId === currentDevice.deviceId"
        >{{ device.label }}</option
      >
    </select>

    <div class="d-flex justify-content-between">
      <div class="form-check mt-2">
        <input
          class="form-check-input"
          name="tryHarder"
          type="checkbox"
          [(ngModel)]="debugMode"
          id="debugMode"
        />
        <label class="form-check-label" for="debugMode">
          Debug
        </label>
      </div>

      <button
        class="btn btn-sm btn-outline-dark mt-2"
        (click)="askForPermissions()"
      >
        Pedir permisos
      </button>
    </div>
  </div>
</ng-template>
